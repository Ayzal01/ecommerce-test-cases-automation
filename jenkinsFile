pipeline {
    agent any

    environment {
        NODEJS_VERSION = '18.17.1' // Set desired Node.js version
    }

    stages {
        stage('Prepare System') {
            steps {
                script {
                    // Install Node.js if not available
                    bat '''
                    where node || (
                        echo Installing Node.js...
                        choco install nodejs-lts -y
                    )
                    '''

                    // Install Allure if not available
                    bat '''
                    where allure || (
                        echo Installing Allure...
                        npm install -g allure-commandline
                    )
                    '''
                }
            }
        }

        stage('Clone Repository') {
            steps {
                git branch: 'main', url: 'https://github.com/Ayzal01/ecommerce-test-cases-automation.git'
            }
        }

        stage('Setup Playwright Project') {
            steps {
                script {
                    bat '''
                    if not exist package.json (
                        echo Initializing new Playwright project...
                        npm init -y
                        npm install -D playwright
                        npx playwright install
                    )
                    '''
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    bat 'npm install'
                    bat 'npx playwright install'
                }
            }
        }

        stage('Run Playwright Tests') {
            steps {
                script {
                    bat 'npx playwright test ./tests --headed --project=DEMOPROJECTPLAYWRIGHT --workers=1'
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    bat 'npx allure generate allure-results --clean -o allure-report'
                }
            }
        }

        stage('Publish Allure Report') {
            steps {
                publishHTML(target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'allure-report',
                    reportFiles: 'index.html',
                    reportName: 'Allure Report'
                ])
            }
        }
    }
}
